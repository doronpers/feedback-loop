#!/usr/bin/env python3
"""
Pre-commit hook for pattern analysis.

This hook analyzes staged changes for pattern violations before allowing commit.
Install: cp hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
"""

import json
import os
import re
import subprocess
import sys
from pathlib import Path


def get_staged_diff():
    """Get diff of staged changes.

    Returns:
        Tuple of (files_changed, diff_content)
    """
    try:
        # Get list of staged files
        result = subprocess.run(
            ["git", "diff", "--cached", "--name-only"],
            capture_output=True,
            text=True,
            check=True
        )
        files = result.stdout.strip().split("\n")

        # Get diff content
        result = subprocess.run(
            ["git", "diff", "--cached"],
            capture_output=True,
            text=True,
            check=True
        )
        diff = result.stdout

        return files, diff
    except subprocess.CalledProcessError as e:
        print(f"Error getting git diff: {e}")
        return [], ""


def analyze_patterns(files, diff):
    """Analyze files and diff for pattern violations.

    Args:
        files: List of changed files
        diff: Git diff content

    Returns:
        List of violations
    """
    violations = []

    # Pattern detection rules
    patterns = {
        "numpy_json_serialization": {
            "regex": r"json\.dumps\([^)]*np\.|json\.dumps\([^)]*numpy",
            "description": "NumPy types may not be JSON serializable",
            "suggestion": "Convert NumPy types to Python types: float(np_value)"
        },
        "bounds_checking": {
            "regex": r"\w+\[0\](?!\s+if\s+\w+)",
            "description": "List access without bounds checking",
            "suggestion": "Check list length before accessing: if items: first = items[0]"
        },
        "bare_except": {
            "regex": r"except\s*:",
            "description": "Bare except clause catches all exceptions",
            "suggestion": "Use specific exceptions: except (TypeError, ValueError) as e:"
        },
        "print_statement": {
            "regex": r"\bprint\s*\(",
            "description": "Print statement instead of logger",
            "suggestion": "Use logger.debug() instead of print()"
        },
    }

    # Analyze each file
    for file in files:
        if not file.endswith(".py"):
            continue

        try:
            with open(file, 'r') as f:
                content = f.read()

            for pattern_name, pattern_info in patterns.items():
                matches = re.finditer(pattern_info["regex"], content)
                for match in matches:
                    # Count line number
                    line_num = content[:match.start()].count("\n") + 1

                    violations.append({
                        "file": file,
                        "line": line_num,
                        "pattern": pattern_name,
                        "description": pattern_info["description"],
                        "suggestion": pattern_info["suggestion"],
                        "code_snippet": content[match.start():match.end()][:50]
                    })
        except Exception as e:
            print(f"Warning: Could not analyze {file}: {e}")

    return violations


def main():
    """Main pre-commit hook entry point."""
    # Check if in git repository
    if not Path(".git").exists():
        sys.exit(0)

    print("ðŸ”„ Running feedback loop pattern analysis...")

    files, diff = get_staged_diff()

    if not files:
        print("âœ“ No files to analyze")
        sys.exit(0)

    violations = analyze_patterns(files, diff)

    if violations:
        print(f"\nâš ï¸  Found {len(violations)} potential pattern violations:\n")

        for v in violations[:10]:  # Limit to 10 violations
            print(f"  {v['file']}:{v['line']}")
            print(f"    Pattern: {v['pattern']}")
            print(f"    Issue: {v['description']}")
            print(f"    Suggestion: {v['suggestion']}")
            print()

        if len(violations) > 10:
            print(f"  ... and {len(violations) - 10} more violations\n")

        # Save violations to file for CI/CD
        with open(".pattern-violations.json", "w") as f:
            json.dump(violations, f, indent=2)

        print("ðŸ’¡ Tip: These are warnings. Review the suggestions above.")
        print("   To bypass this check: git commit --no-verify")
        print()

        # Don't block commit, just warn
        # To block commits, change to: sys.exit(1)
        sys.exit(0)
    else:
        print("âœ“ No pattern violations detected")
        sys.exit(0)


if __name__ == "__main__":
    main()

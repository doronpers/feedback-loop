#!/usr/bin/env python3
"""
Feedback Loop Quick Start - One-Click Experience

Launches feedback-loop with zero configuration - from first click to productive.
Combines bootstrap, demo, and dashboard in a seamless experience.
"""

import os
import subprocess
import sys
import time
import webbrowser
from pathlib import Path

# Add parent directory to path for imports
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

# Load .env file from project root
from metrics.env_loader import load_env_file

load_env_file(project_root)

# Try to import rich, but handle gracefully if not available
try:
    from rich.align import Align
    from rich.console import Console
    from rich.live import Live
    from rich.panel import Panel
    from rich.spinner import Spinner
    from rich.text import Text
    from rich.theme import Theme

    RICH_AVAILABLE = True
except ImportError:
    RICH_AVAILABLE = False

    # Fallback: use basic print if rich not available
    class Console:
        def __init__(self, theme=None, **kwargs):
            # Accept theme parameter but ignore it
            pass

        def print(self, *args, **kwargs):
            # Strip rich markup tags for cleaner output
            import re

            text = " ".join(str(arg) for arg in args)
            # Remove rich markup like [cyan], [bold], etc.
            text = re.sub(r"\[[^\]]+\]", "", text)
            print(text)

        def status(self, *args, **kwargs):
            return self

        def __enter__(self):
            return self

        def __exit__(self, *args):
            pass

    class Panel:
        @staticmethod
        def fit(text, **kwargs):
            return text

    class Text:
        def __init__(self, text, **kwargs):
            self.text = text

        def __str__(self):
            return self.text

    class Theme:
        def __init__(self, *args, **kwargs):
            pass

    Align = None
    Live = None
    Spinner = None

# Custom theme (only if rich available)
if RICH_AVAILABLE:
    custom_theme = Theme(
        {
            "info": "cyan",
            "warning": "yellow",
            "error": "red",
            "success": "green",
            "header": "bold blue",
            "accent": "magenta",
        }
    )
    console = Console(theme=custom_theme)
else:
    custom_theme = None
    console = Console()


class QuickStart:
    """One-click feedback-loop experience."""

    def __init__(self):
        """Initialize quick start."""
        self.project_root = Path(__file__).parent.parent

    def show_welcome(self):
        """Show the welcome screen."""
        welcome_text = Text("üöÄ Welcome to Feedback Loop!", style="header")
        subtitle = Text("AI-Assisted Development with Continuous Learning", style="accent")

        console.print()
        console.print(Panel.fit(welcome_text, border_style="blue"))
        console.print(subtitle, justify="center")
        console.print()

        # Show what will happen
        steps = [
            "üîß Auto-setup and install dependencies",
            "üé≠ Launch interactive pattern demo",
            "üìä Open analytics dashboard in browser",
            "üöÄ Get you coding with AI assistance!",
        ]

        console.print("‚ö° [bold]What happens next:[/bold]")
        for step in steps:
            console.print(f"   {step}")
        console.print()

        console.print(
            "üí° [italic]Press Ctrl+C anytime to stop. Everything is safe![/italic]", justify="center"
        )
        console.print()

    def check_environment(self):
        """Quick environment check."""
        checks = []

        # Python version
        version = sys.version_info
        python_ok = version >= (3, 8)
        checks.append(("Python 3.8+", "‚úÖ" if python_ok else "‚ùå", python_ok))

        # Git repository
        git_ok = Path(".git").is_dir()
        checks.append(("Git Repository", "‚úÖ" if git_ok else "‚ùå", git_ok))

        # Critical issues
        critical_issues = [name for name, status, ok in checks if not ok]

        if critical_issues:
            console.print("‚ùå [red]Critical issues found:[/red]")
            for issue in critical_issues:
                console.print(f"   ‚Ä¢ {issue}")
            console.print("\nüí° Please resolve these issues and try again.")
            return False

        return True

    def run_bootstrap(self):
        """Run bootstrap if needed."""
        if RICH_AVAILABLE:
            console.print("üîß [cyan]Checking setup...[/cyan]")
            with console.status("[bold green]Checking environment...", spinner="dots"):
                time.sleep(0.5)  # Brief pause for UX
        else:
            print("üîß Checking setup...")

        # Check if we need to install
        try:
            import fastapi
            import passlib  # Required for api.main
            import rich
            import uvicorn  # Required for server

            import metrics

            if RICH_AVAILABLE:
                console.print("‚úÖ [green]Already set up! Skipping installation.[/green]")
            else:
                print("‚úÖ Already set up! Skipping installation.")
            return True
        except ImportError as e:
            missing_module = e.name if hasattr(e, "name") else str(e)

            # If critical dependencies are missing, install them directly
            critical_modules = ["rich", "passlib", "uvicorn"]
            if missing_module in critical_modules:
                module_name = missing_module
                if RICH_AVAILABLE:
                    console.print(
                        f"üì¶ [yellow]Installing {module_name} (required dependency)...[/yellow]"
                    )
                else:
                    print(f"üì¶ Installing {module_name} (required dependency)...")

                try:
                    result = subprocess.run(
                        [sys.executable, "-m", "pip", "install", module_name],
                        cwd=self.project_root,
                        capture_output=True,
                        text=True,
                        timeout=60,
                    )

                    if result.returncode == 0:
                        if RICH_AVAILABLE:
                            console.print(f"‚úÖ [green]{module_name} installed successfully[/green]")
                        else:
                            print(f"‚úÖ {module_name} installed successfully")

                        # Retry the import check after installation
                        # This handles the case where we install a module and need to verify all dependencies
                        # Recursively call run_bootstrap to check all dependencies again
                        return self.run_bootstrap()
                    else:
                        if RICH_AVAILABLE:
                            console.print(
                                f"‚ùå [red]Failed to install {module_name}: {result.stderr[:200]}[/red]"
                            )
                        else:
                            print(f"‚ùå Failed to install {module_name}: {result.stderr[:200]}")
                        return False
                except Exception as install_error:
                    if RICH_AVAILABLE:
                        console.print(
                            f"‚ùå [red]Error installing {module_name}: {install_error}[/red]"
                        )
                    else:
                        print(f"‚ùå Error installing {module_name}: {install_error}")
                    return False

            # If we get here, missing_module is not in critical_modules, so we need to run bootstrap
            if RICH_AVAILABLE:
                console.print(f"üì¶ [yellow]Need to install dependencies ({missing_module})[/yellow]")
            else:
                print(f"üì¶ Need to install dependencies ({missing_module})")

        # Run bootstrap
        console.print("üîß [cyan]Running first-time setup...[/cyan]")
        try:
            result = subprocess.run(
                [sys.executable, "bin/fl-bootstrap"],
                cwd=self.project_root,
                capture_output=True,
                text=True,
                timeout=300,  # 5 minute timeout
            )

            if result.returncode == 0:
                console.print("‚úÖ [green]Setup completed successfully[/green]")
                return True
            else:
                console.print(f"‚ùå [red]Setup failed: {result.stderr}[/red]")
                return False

        except subprocess.TimeoutExpired:
            console.print("‚ùå [red]Setup timed out[/red]")
            return False
        except Exception as e:
            console.print(f"‚ùå [red]Setup error: {e}[/red]")
            return False

    def launch_demo(self):
        """Launch the interactive demo."""
        console.print("\nüé≠ [cyan]Starting interactive demo...[/cyan]")

        try:
            # Launch demo in background
            demo_process = subprocess.Popen(
                [sys.executable, "bin/fl-demo"],
                cwd=self.project_root,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
            )

            console.print("‚úÖ [green]Demo launched successfully[/green]")
            console.print("   üí° The demo will show you pattern examples and let you experiment")
            console.print("   üìù Follow the on-screen instructions to explore")

            return demo_process

        except Exception as e:
            console.print(f"‚ùå [red]Failed to launch demo: {e}[/red]")
            return None

    def launch_dashboard(self):
        """Launch the analytics dashboard."""
        if RICH_AVAILABLE:
            console.print("\nüìä [cyan]Opening analytics dashboard...[/cyan]")
        else:
            print("\nüìä Opening analytics dashboard...")

        # Get local IP address for network access
        def get_local_ip():
            """Get the local IP address for network access."""
            try:
                import socket

                # Connect to a remote address to determine local IP
                s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
                s.connect(("8.8.8.8", 80))
                ip = s.getsockname()[0]
                s.close()
                return ip
            except Exception:
                return None

        local_ip = get_local_ip()

        try:
            # Check if port 8000 is already in use
            import socket

            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            port_in_use = sock.connect_ex(("127.0.0.1", 8000)) == 0
            sock.close()

            if port_in_use:
                # Check if the existing server has the dashboard route
                import urllib.request

                try:
                    test_url = "http://127.0.0.1:8000/dashboard/"
                    req = urllib.request.Request(test_url)
                    req.add_header("User-Agent", "feedback-loop-check")
                    with urllib.request.urlopen(req, timeout=2) as response:
                        if response.status == 200:
                            # Dashboard route exists

                            if RICH_AVAILABLE:
                                console.print(
                                    "‚úÖ [green]Dashboard already running on port 8000[/green]"
                                )
                            else:
                                print("‚úÖ Dashboard already running on port 8000")
                            dashboard_url = "http://127.0.0.1:8000/dashboard/"
                            network_url = f"http://{local_ip}:8000/dashboard/" if local_ip else None
                            if RICH_AVAILABLE:
                                console.print(f"   üåê Local: {dashboard_url}")
                                if network_url:
                                    console.print(f"   üåê Network: {network_url}")
                            else:
                                print(f"   üåê Local: {dashboard_url}")
                                if network_url:
                                    print(f"   üåê Network: {network_url}")
                            try:
                                webbrowser.open(dashboard_url)
                            except Exception:
                                pass
                            return None
                except urllib.error.HTTPError as e:
                    if e.code == 404:
                        if RICH_AVAILABLE:
                            console.print(
                                "‚ö†Ô∏è [yellow]Port 8000 is in use, but dashboard route not found.[/yellow]"
                            )
                            console.print(
                                "   [yellow]This may be a different server. Trying a different port...[/yellow]"
                            )
                        else:
                            print("‚ö†Ô∏è Port 8000 is in use, but dashboard route not found.")
                            print("   This may be a different server. Trying a different port...")
                        # Fall through to start on different port
                    else:
                        # Other error - assume server is different
                        if RICH_AVAILABLE:
                            console.print(
                                "‚ö†Ô∏è [yellow]Port 8000 is in use by a different server.[/yellow]"
                            )
                            console.print("   [yellow]Trying a different port...[/yellow]")
                        else:
                            print("‚ö†Ô∏è Port 8000 is in use by a different server.")
                            print("   Trying a different port...")
                        # Fall through to start on different port
                except Exception as e:
                    if RICH_AVAILABLE:
                        console.print(f"‚ö†Ô∏è [yellow]Could not check existing server: {e}[/yellow]")
                        console.print("   [yellow]Trying a different port...[/yellow]")
                    else:
                        print(f"‚ö†Ô∏è Could not check existing server: {e}")
                        print("   Trying a different port...")
                    # Fall through to start on different port

                # Try alternative ports
                for alt_port in [8001, 8002, 8003]:
                    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    port_available = sock.connect_ex(("127.0.0.1", alt_port)) != 0
                    sock.close()

                    if port_available:
                        if RICH_AVAILABLE:
                            console.print(
                                f"üìä [cyan]Starting dashboard on port {alt_port}...[/cyan]"
                            )
                        else:
                            print(f"üìä Starting dashboard on port {alt_port}...")

                        dashboard_process = subprocess.Popen(
                            [
                                sys.executable,
                                "-m",
                                "uvicorn",
                                "api.main:app",
                                "--host",
                                "0.0.0.0",
                                "--port",
                                str(alt_port),
                                "--reload",
                            ],
                            cwd=self.project_root,
                            stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE,
                        )

                        # Check if process crashed immediately
                        time.sleep(1)
                        if dashboard_process.poll() is not None:
                            stderr_output = (
                                dashboard_process.stderr.read().decode("utf-8", errors="ignore")
                                if dashboard_process.stderr
                                else "No stderr"
                            )
                            stdout_output = (
                                dashboard_process.stdout.read().decode("utf-8", errors="ignore")
                                if dashboard_process.stdout
                                else "No stdout"
                            )

                            if RICH_AVAILABLE:
                                console.print(
                                    f"‚ùå [red]Dashboard failed to start on port {alt_port}:[/red]"
                                )
                                console.print(f"   [red]{stderr_output[:300]}[/red]")
                            else:
                                print(f"‚ùå Dashboard failed to start on port {alt_port}:")
                                print(f"   {stderr_output[:300]}")
                            continue  # Try next port

                        # Wait for server to be ready and verify
                        dashboard_url = f"http://127.0.0.1:{alt_port}/dashboard/"
                        max_wait = 10
                        waited = 0
                        server_ready = False

                        while waited < max_wait:
                            time.sleep(1)
                            waited += 1
                            try:
                                sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                                sock.settimeout(1)
                                result = sock.connect_ex(("127.0.0.1", alt_port))
                                sock.close()
                                if result == 0:
                                    # Also verify HTTP response
                                    try:
                                        import urllib.request

                                        response = urllib.request.urlopen(
                                            f"http://127.0.0.1:{alt_port}/", timeout=2
                                        )
                                        status_code = response.getcode()
                                        server_ready = True
                                        break
                                    except Exception as http_err:
                                        continue
                            except Exception as sock_err:
                                pass

                        if not server_ready:
                            # Check if process crashed during wait
                            if dashboard_process.poll() is not None:
                                stderr_output = (
                                    dashboard_process.stderr.read().decode("utf-8", errors="ignore")
                                    if dashboard_process.stderr
                                    else "No stderr"
                                )

                                if RICH_AVAILABLE:
                                    console.print(
                                        f"‚ùå [red]Dashboard crashed on port {alt_port}: {stderr_output[:200]}[/red]"
                                    )
                                else:
                                    print(
                                        f"‚ùå Dashboard crashed on port {alt_port}: {stderr_output[:200]}"
                                    )
                                continue
                            else:
                                if RICH_AVAILABLE:
                                    console.print(
                                        f"‚ö†Ô∏è [yellow]Dashboard on port {alt_port} not responding after {max_wait}s[/yellow]"
                                    )
                                else:
                                    print(
                                        f"‚ö†Ô∏è Dashboard on port {alt_port} not responding after {max_wait}s"
                                    )
                                continue

                        try:
                            webbrowser.open(f"http://127.0.0.1:{alt_port}/")
                            if RICH_AVAILABLE:
                                console.print(
                                    f"‚úÖ [green]Dashboard opened on port {alt_port}[/green]"
                                )
                                console.print(f"   üåê Local: {dashboard_url}")
                                if local_ip:
                                    console.print(
                                        f"   üåê Network: http://{local_ip}:{alt_port}/dashboard/"
                                    )
                            else:
                                print(f"‚úÖ Dashboard opened on port {alt_port}")
                                print(f"   üåê Local: {dashboard_url}")
                                if local_ip:
                                    print(f"   üåê Network: http://{local_ip}:{alt_port}/dashboard/")
                        except Exception:
                            if RICH_AVAILABLE:
                                console.print(
                                    f"‚úÖ [green]Dashboard started on port {alt_port}[/green]"
                                )
                                console.print(f"   üåê Local: {dashboard_url}")
                                if local_ip:
                                    console.print(
                                        f"   üåê Network: http://{local_ip}:{alt_port}/dashboard/"
                                    )
                            else:
                                print(f"‚úÖ Dashboard started on port {alt_port}")
                                print(f"   üåê Local: {dashboard_url}")
                                if local_ip:
                                    print(f"   üåê Network: http://{local_ip}:{alt_port}/dashboard/")
                        return dashboard_process

                # No available ports
                if RICH_AVAILABLE:
                    console.print("‚ùå [red]No available ports found (8000-8003 all in use)[/red]")
                else:
                    print("‚ùå No available ports found (8000-8003 all in use)")
                return None

            # Start dashboard server

            dashboard_process = subprocess.Popen(
                [
                    sys.executable,
                    "-m",
                    "uvicorn",
                    "api.main:app",
                    "--host",
                    "0.0.0.0",
                    "--port",
                    "8000",
                    "--reload",
                ],
                cwd=self.project_root,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
            )

            # Check immediately if process crashed
            time.sleep(1)  # Give it a moment to start or fail
            if dashboard_process.poll() is not None:
                # Process already exited - read stderr
                stderr_output = (
                    dashboard_process.stderr.read().decode("utf-8", errors="ignore")
                    if dashboard_process.stderr
                    else "No stderr available"
                )
                stdout_output = (
                    dashboard_process.stdout.read().decode("utf-8", errors="ignore")
                    if dashboard_process.stdout
                    else "No stdout available"
                )

                if RICH_AVAILABLE:
                    console.print(f"‚ùå [red]Dashboard server failed to start:[/red]")
                    console.print(f"   [red]Error: {stderr_output[:300]}[/red]")
                else:
                    print(f"‚ùå Dashboard server failed to start:")
                    print(f"   Error: {stderr_output[:300]}")
                return None

            # Wait for server to start and verify it's responding
            dashboard_url = "http://127.0.0.1:8000/dashboard/"
            max_wait = 10  # Wait up to 10 seconds
            waited = 0
            server_ready = False

            while waited < max_wait:
                time.sleep(1)
                waited += 1
                try:
                    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    sock.settimeout(1)
                    result = sock.connect_ex(("127.0.0.1", 8000))
                    sock.close()
                    if result == 0:
                        server_ready = True
                        break
                except Exception:
                    pass

            if not server_ready:
                # Check if process crashed
                if dashboard_process.poll() is not None:
                    # Process exited - read stderr to see why
                    stderr_output = (
                        dashboard_process.stderr.read().decode("utf-8", errors="ignore")
                        if dashboard_process.stderr
                        else "No stderr available"
                    )
                    if RICH_AVAILABLE:
                        console.print(
                            f"‚ùå [red]Dashboard server failed to start: {stderr_output[:200]}[/red]"
                        )
                    else:
                        print(f"‚ùå Dashboard server failed to start: {stderr_output[:200]}")
                    return None
                else:
                    if RICH_AVAILABLE:
                        console.print(
                            "‚ö†Ô∏è [yellow]Dashboard server starting (may take a moment)...[/yellow]"
                        )
                    else:
                        print("‚ö†Ô∏è Dashboard server starting (may take a moment)...")

            # Try to open browser - use root URL which redirects to dashboard
            root_url = "http://127.0.0.1:8000/"
            network_url = f"http://{local_ip}:8000/" if local_ip else None
            try:
                webbrowser.open(root_url)
                if RICH_AVAILABLE:
                    console.print("‚úÖ [green]Dashboard opened in your browser[/green]")
                    console.print(f"   üåê Local: {root_url} (redirects to {dashboard_url})")
                    if network_url:
                        console.print(
                            f"   üåê Network: {network_url} (accessible from other devices)"
                        )
                else:
                    print("‚úÖ Dashboard opened in your browser")
                    print(f"   üåê Local: {root_url} (redirects to {dashboard_url})")
                    if network_url:
                        print(f"   üåê Network: {network_url} (accessible from other devices)")
            except Exception as e:
                if RICH_AVAILABLE:
                    console.print(f"‚úÖ [green]Dashboard server started[/green]")
                    console.print(f"   üåê Local: {root_url} or {dashboard_url}")
                    if network_url:
                        console.print(
                            f"   üåê Network: {network_url} (accessible from other devices)"
                        )
                else:
                    print("‚úÖ Dashboard server started")
                    print(f"   üåê Local: {root_url} or {dashboard_url}")
                    if network_url:
                        print(f"   üåê Network: {network_url} (accessible from other devices)")

            return dashboard_process

        except Exception as e:
            if RICH_AVAILABLE:
                console.print(f"‚ùå [red]Failed to launch dashboard: {e}[/red]")
            else:
                print(f"‚ùå Failed to launch dashboard: {e}")
            return None

    def show_next_steps(self):
        """Show next steps for continued usage."""
        console.print("\n" + "üéØ You're all set! Here's what you can do next:")

        steps = [
            ("üí¨ Chat with AI", "fl-chat", "Get coding help from the AI assistant"),
            ("üîç Explore Patterns", "fl-explore", "Browse and learn about coding patterns"),
            ("üîß Apply Patterns", "fl-apply --scan .", "Automatically fix patterns in your code"),
            ("üìä View Analytics", "fl-dashboard", "Open the analytics dashboard anytime"),
            ("üìñ Read Docs", "Open documentation/QUICKSTART.md", "Complete getting started guide"),
        ]

        for i, (title, command, description) in enumerate(steps, 1):
            console.print(f"\n   {i}. [bold cyan]{title}[/bold cyan]")
            console.print(f"      [green]{command}[/green]")
            console.print(f"      [yellow]{description}[/yellow]")

        console.print("\n" + "üí° Pro tip: Run 'fl-chat' to ask questions about feedback-loop!")
        console.print("üöÄ Happy coding with AI-assisted development!")

    def run(self):
        """Run the complete quick start experience."""
        self.show_welcome()

        # Quick environment check
        if not self.check_environment():
            return 1

        # Run bootstrap if needed
        if not self.run_bootstrap():
            return 1

        # Launch demo
        demo_process = self.launch_demo()

        # Launch dashboard
        dashboard_process = self.launch_dashboard()

        # Show next steps
        self.show_next_steps()

        console.print("\n" + "=" * 60, style="header")
        console.print("‚ú® Feedback Loop is ready! ‚ú®", justify="center", style="success")
        console.print("=" * 60, style="header")

        # Show what was accomplished
        console.print("\nüéØ [bold green]What you accomplished:[/bold green]")
        accomplishments = [
            "‚úÖ Environment auto-detected and configured",
            "‚úÖ All dependencies installed automatically",
            "üé≠ Interactive demo showing real patterns",
            "üìä Analytics dashboard ready in browser",
            "üöÄ AI-assisted development tools available",
        ]

        for acc in accomplishments:
            console.print(f"   {acc}")

        console.print("\n‚è±Ô∏è  [yellow]Total time: ~30 seconds![/yellow]")
        console.print(
            "üí° [italic]You're now ready to write better code with AI assistance![/italic]"
        )

        # Keep processes running until user interrupts
        try:
            console.print("\nüîÑ Press Ctrl+C to stop all services")
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            console.print("\n\nüëã Shutting down services...")

            # Clean up processes
            if demo_process and demo_process.poll() is None:
                demo_process.terminate()
                demo_process.wait(timeout=5)

            if dashboard_process and dashboard_process.poll() is None:
                dashboard_process.terminate()
                dashboard_process.wait(timeout=5)

            console.print("‚úÖ All services stopped. Run 'fl-start' anytime to restart!")

        return 0


def main():
    """Main entry point."""
    starter = QuickStart()
    return starter.run()


if __name__ == "__main__":
    sys.exit(main())

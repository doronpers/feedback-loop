#!/usr/bin/env python3
"""
Feedback Loop Quick Start - One-Click Experience

Launches feedback-loop with zero configuration - from first click to productive.
Combines bootstrap, demo, and dashboard in a seamless experience.
"""

import os
import subprocess
import sys
import time
import webbrowser
from pathlib import Path

# Add parent directory to path for imports
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

# Load .env file from project root
from metrics.env_loader import load_env_file

load_env_file(project_root)

from rich.align import Align
from rich.console import Console
from rich.live import Live
from rich.panel import Panel
from rich.spinner import Spinner
from rich.text import Text
from rich.theme import Theme

# Custom theme
custom_theme = Theme(
    {
        "info": "cyan",
        "warning": "yellow",
        "error": "red",
        "success": "green",
        "header": "bold blue",
        "accent": "magenta",
    }
)

console = Console(theme=custom_theme)


class QuickStart:
    """One-click feedback-loop experience."""

    def __init__(self):
        """Initialize quick start."""
        self.project_root = Path(__file__).parent.parent

    def show_welcome(self):
        """Show the welcome screen."""
        welcome_text = Text("ğŸš€ Welcome to Feedback Loop!", style="header")
        subtitle = Text("AI-Assisted Development with Continuous Learning", style="accent")

        console.print()
        console.print(Panel.fit(welcome_text, border_style="blue"))
        console.print(subtitle, justify="center")
        console.print()

        # Show what will happen
        steps = [
            "ğŸ”§ Auto-setup and install dependencies",
            "ğŸ­ Launch interactive pattern demo",
            "ğŸ“Š Open analytics dashboard in browser",
            "ğŸš€ Get you coding with AI assistance!",
        ]

        console.print("âš¡ [bold]What happens next:[/bold]")
        for step in steps:
            console.print(f"   {step}")
        console.print()

        console.print(
            "ğŸ’¡ [italic]Press Ctrl+C anytime to stop. Everything is safe![/italic]", justify="center"
        )
        console.print()

    def check_environment(self):
        """Quick environment check."""
        checks = []

        # Python version
        version = sys.version_info
        python_ok = version >= (3, 8)
        checks.append(("Python 3.8+", "âœ…" if python_ok else "âŒ", python_ok))

        # Git repository
        git_ok = Path(".git").is_dir()
        checks.append(("Git Repository", "âœ…" if git_ok else "âŒ", git_ok))

        # Critical issues
        critical_issues = [name for name, status, ok in checks if not ok]

        if critical_issues:
            console.print("âŒ [red]Critical issues found:[/red]")
            for issue in critical_issues:
                console.print(f"   â€¢ {issue}")
            console.print("\nğŸ’¡ Please resolve these issues and try again.")
            return False

        return True

    def run_bootstrap(self):
        """Run bootstrap if needed."""
        console.print("ğŸ”§ [cyan]Checking setup...[/cyan]")

        with console.status("[bold green]Checking environment...", spinner="dots"):
            time.sleep(0.5)  # Brief pause for UX

        # Check if we need to install
        try:
            import fastapi
            import rich

            import metrics

            console.print("âœ… [green]Already set up! Skipping installation.[/green]")
            return True
        except ImportError as e:
            console.print(f"ğŸ“¦ [yellow]Need to install dependencies ({e.name})[/yellow]")

        # Run bootstrap
        console.print("ğŸ”§ [cyan]Running first-time setup...[/cyan]")
        try:
            result = subprocess.run(
                [sys.executable, "bin/fl-bootstrap"],
                cwd=self.project_root,
                capture_output=True,
                text=True,
                timeout=300,  # 5 minute timeout
            )

            if result.returncode == 0:
                console.print("âœ… [green]Setup completed successfully[/green]")
                return True
            else:
                console.print(f"âŒ [red]Setup failed: {result.stderr}[/red]")
                return False

        except subprocess.TimeoutExpired:
            console.print("âŒ [red]Setup timed out[/red]")
            return False
        except Exception as e:
            console.print(f"âŒ [red]Setup error: {e}[/red]")
            return False

    def launch_demo(self):
        """Launch the interactive demo."""
        console.print("\nğŸ­ [cyan]Starting interactive demo...[/cyan]")

        try:
            # Launch demo in background
            demo_process = subprocess.Popen(
                [sys.executable, "bin/fl-demo"],
                cwd=self.project_root,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
            )

            console.print("âœ… [green]Demo launched successfully[/green]")
            console.print("   ğŸ’¡ The demo will show you pattern examples and let you experiment")
            console.print("   ğŸ“ Follow the on-screen instructions to explore")

            return demo_process

        except Exception as e:
            console.print(f"âŒ [red]Failed to launch demo: {e}[/red]")
            return None

    def launch_dashboard(self):
        """Launch the analytics dashboard."""
        console.print("\nğŸ“Š [cyan]Opening analytics dashboard...[/cyan]")

        try:
            # Start dashboard server
            dashboard_process = subprocess.Popen(
                [
                    sys.executable,
                    "-m",
                    "uvicorn",
                    "api.main:app",
                    "--host",
                    "127.0.0.1",
                    "--port",
                    "8000",
                    "--reload",
                ],
                cwd=self.project_root,
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
            )

            # Wait a moment for server to start
            time.sleep(2)

            # Try to open browser
            dashboard_url = "http://127.0.0.1:8000/dashboard/"
            try:
                webbrowser.open(dashboard_url)
                console.print("âœ… [green]Dashboard opened in your browser[/green]")
                console.print(f"   ğŸŒ URL: {dashboard_url}")
            except Exception:
                console.print(f"âœ… [green]Dashboard server started[/green]")
                console.print(f"   ğŸŒ Open in browser: {dashboard_url}")

            return dashboard_process

        except Exception as e:
            console.print(f"âŒ [red]Failed to launch dashboard: {e}[/red]")
            return None

    def show_next_steps(self):
        """Show next steps for continued usage."""
        console.print("\n" + "ğŸ¯ You're all set! Here's what you can do next:")

        steps = [
            ("ğŸ’¬ Chat with AI", "fl-chat", "Get coding help from the AI assistant"),
            ("ğŸ” Explore Patterns", "fl-explore", "Browse and learn about coding patterns"),
            ("ğŸ”§ Apply Patterns", "fl-apply --scan .", "Automatically fix patterns in your code"),
            ("ğŸ“Š View Analytics", "fl-dashboard", "Open the analytics dashboard anytime"),
            ("ğŸ“– Read Docs", "Open documentation/QUICKSTART.md", "Complete getting started guide"),
        ]

        for i, (title, command, description) in enumerate(steps, 1):
            console.print(f"\n   {i}. [bold cyan]{title}[/bold cyan]")
            console.print(f"      [green]{command}[/green]")
            console.print(f"      [yellow]{description}[/yellow]")

        console.print("\n" + "ğŸ’¡ Pro tip: Run 'fl-chat' to ask questions about feedback-loop!")
        console.print("ğŸš€ Happy coding with AI-assisted development!")

    def run(self):
        """Run the complete quick start experience."""
        self.show_welcome()

        # Quick environment check
        if not self.check_environment():
            return 1

        # Run bootstrap if needed
        if not self.run_bootstrap():
            return 1

        # Launch demo
        demo_process = self.launch_demo()

        # Launch dashboard
        dashboard_process = self.launch_dashboard()

        # Show next steps
        self.show_next_steps()

        console.print("\n" + "=" * 60, style="header")
        console.print("âœ¨ Feedback Loop is ready! âœ¨", justify="center", style="success")
        console.print("=" * 60, style="header")

        # Show what was accomplished
        console.print("\nğŸ¯ [bold green]What you accomplished:[/bold green]")
        accomplishments = [
            "âœ… Environment auto-detected and configured",
            "âœ… All dependencies installed automatically",
            "ğŸ­ Interactive demo showing real patterns",
            "ğŸ“Š Analytics dashboard ready in browser",
            "ğŸš€ AI-assisted development tools available",
        ]

        for acc in accomplishments:
            console.print(f"   {acc}")

        console.print("\nâ±ï¸  [yellow]Total time: ~30 seconds![/yellow]")
        console.print(
            "ğŸ’¡ [italic]You're now ready to write better code with AI assistance![/italic]"
        )

        # Keep processes running until user interrupts
        try:
            console.print("\nğŸ”„ Press Ctrl+C to stop all services")
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            console.print("\n\nğŸ‘‹ Shutting down services...")

            # Clean up processes
            if demo_process and demo_process.poll() is None:
                demo_process.terminate()
                demo_process.wait(timeout=5)

            if dashboard_process and dashboard_process.poll() is None:
                dashboard_process.terminate()
                dashboard_process.wait(timeout=5)

            console.print("âœ… All services stopped. Run 'fl-start' anytime to restart!")

        return 0


def main():
    """Main entry point."""
    starter = QuickStart()
    return starter.run()


if __name__ == "__main__":
    sys.exit(main())

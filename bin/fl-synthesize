#!/usr/bin/env python3
"""
Interactive Code Synthesizer

Allows users to paste code snippets and synthesize them into an optimal version.
"""

import sys
from pathlib import Path

# Add parent directory to path
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

# Load .env file from project root
from metrics.env_loader import load_env_file

load_env_file(project_root)

from metrics.integrate import MetricsIntegration


def main():
    """Run interactive synthesis."""
    print("=" * 60)
    print("Interactive Code Synthesizer")
    print("=" * 60)
    print("\nThis tool helps you synthesize multiple code versions into one optimal solution.\n")

    # Get prompt
    prompt = input("What problem are these code snippets solving? ")
    if not prompt.strip():
        prompt = "Synthesize the best version from the provided code"

    # Ask for number of snippets
    try:
        num_snippets = int(input("\nHow many code snippets will you provide? (2-5): ") or "2")
        num_snippets = max(2, min(5, num_snippets))
    except ValueError:
        num_snippets = 2

    print(f"\n{num_snippets} snippets selected.")
    print("\nInstructions:")
    print("  1. Paste each code snippet when prompted")
    print("  2. Type 'END' on a new line when done with each snippet")
    print("  3. The tool will synthesize the best version\n")

    input("Press Enter to begin...")

    # Collect snippets
    snippets = []
    for i in range(num_snippets):
        print(f"\n{'='*60}")
        print(f"Snippet {i+1}/{num_snippets}")
        print(f"{'='*60}")
        lines = []
        while True:
            try:
                line = input()
                if line.strip() == "END":
                    break
                lines.append(line)
            except EOFError:
                break

        code = "\n".join(lines).strip()
        if code:
            snippets.append(code)
            print(f"✓ Snippet {i+1} captured ({len(code)} chars)")

    if len(snippets) < 2:
        print("\n❌ Need at least 2 snippets to synthesize. Exiting.")
        return 1

    # Save snippets to temp files
    import tempfile

    temp_files = []
    for i, snippet in enumerate(snippets):
        f = tempfile.NamedTemporaryFile(mode="w", suffix=".py", delete=False)
        f.write(snippet)
        f.close()
        temp_files.append(f.name)

    # Run synthesis
    try:
        integration = MetricsIntegration()
        integration.synthesize_code(
            prompt=prompt, input_files=temp_files, output_file="synthesized_code.py"
        )
    finally:
        # Cleanup temp files
        import os

        for f in temp_files:
            try:
                os.unlink(f)
            except:
                pass

    return 0


if __name__ == "__main__":
    sys.exit(main())

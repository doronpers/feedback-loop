#!/usr/bin/env python3
"""
Feedback Loop Bootstrap - Unified Setup Command

Auto-detects environment and guides users through complete setup in under 5 minutes.
Handles OS detection, Python validation, virtual environment setup, and dependency installation.
"""

import os
import platform
import subprocess
import sys
import tempfile
from pathlib import Path

# Add parent directory to path for imports
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

# Load .env file from project root
from metrics.env_loader import load_env_file

load_env_file(project_root)

from rich.console import Console
from rich.panel import Panel
from rich.progress import BarColumn, Progress, SpinnerColumn, TextColumn, TimeElapsedColumn
from rich.prompt import Confirm, Prompt
from rich.table import Table
from rich.text import Text
from rich.theme import Theme

# Custom theme for consistent styling
custom_theme = Theme(
    {
        "info": "cyan",
        "warning": "yellow",
        "error": "red",
        "success": "green",
        "header": "bold blue",
        "accent": "magenta",
    }
)

console = Console(theme=custom_theme)


class BootstrapWizard:
    """Unified bootstrap wizard for feedback-loop setup."""

    def __init__(self):
        """Initialize bootstrap wizard."""
        self.checks = {}
        self.issues = []
        self.suggestions = []

    def print_header(self):
        """Print welcome header."""
        header_text = Text("ğŸš€ Feedback Loop Bootstrap", style="header")
        subtitle = Text("Unified setup for smarter, AI-assisted development", style="accent")

        console.print()
        console.print(Panel.fit(header_text, border_style="blue"))
        console.print(subtitle, justify="center")
        console.print()

    def detect_os(self) -> dict:
        """Detect operating system and architecture."""
        system = platform.system().lower()
        machine = platform.machine().lower()

        os_info = {
            "system": system,
            "machine": machine,
            "is_windows": system == "windows",
            "is_macos": system == "darwin",
            "is_linux": system == "linux",
            "is_arm": "arm" in machine or "aarch64" in machine,
            "display_name": self._get_os_display_name(system, machine),
        }

        return os_info

    def _get_os_display_name(self, system: str, machine: str) -> str:
        """Get human-readable OS name."""
        if system == "darwin":
            return "macOS"
        elif system == "windows":
            return "Windows"
        elif system == "linux":
            if "arm" in machine or "aarch64" in machine:
                return "Linux (ARM)"
            else:
                return "Linux"
        else:
            return f"{system.title()} ({machine})"

    def check_python_version(self) -> dict:
        """Check Python version compatibility."""
        version = sys.version_info
        version_str = f"{version.major}.{version.minor}.{version.micro}"

        is_compatible = version >= (3, 8)
        min_version = "3.8.0"

        result = {
            "version": version_str,
            "is_compatible": is_compatible,
            "min_version": min_version,
            "status": "âœ… Compatible" if is_compatible else "âŒ Too old",
            "message": f"Python {version_str} detected",
        }

        if not is_compatible:
            result["message"] += f" (requires {min_version}+)"
            self.issues.append("Python version too old")
            self.suggestions.append(f"Upgrade Python to {min_version} or newer")

        return result

    def check_virtual_environment(self) -> dict:
        """Check if running in a virtual environment."""
        in_venv = sys.prefix != sys.base_prefix
        venv_path = sys.prefix if in_venv else None

        result = {
            "in_venv": in_venv,
            "venv_path": venv_path,
            "status": "âœ… Active" if in_venv else "âš ï¸  Not active",
            "message": f"Virtual environment: {'Active' if in_venv else 'Not active'}",
        }

        if not in_venv:
            self.issues.append("Not using virtual environment")
            self.suggestions.append("Consider using a virtual environment for isolation")

        return result

    def check_dependencies(self) -> dict:
        """Check for required dependencies."""
        required_deps = [
            ("pip", "pip"),
            ("numpy", "numpy"),
            ("fastapi", "fastapi"),
            ("rich", "rich"),  # For this bootstrap tool
        ]

        results = {}
        missing_deps = []

        for name, import_name in required_deps:
            try:
                __import__(import_name)
                results[name] = {"installed": True, "version": "âœ“"}
            except ImportError:
                results[name] = {"installed": False, "version": "âœ—"}
                missing_deps.append(name)

        result = {
            "dependencies": results,
            "missing": missing_deps,
            "all_installed": len(missing_deps) == 0,
            "status": "âœ… All installed"
            if len(missing_deps) == 0
            else f"âš ï¸  {len(missing_deps)} missing",
        }

        if missing_deps:
            self.issues.append(f"Missing dependencies: {', '.join(missing_deps)}")
            self.suggestions.append("Run 'pip install -e .' to install missing dependencies")

        return result

    def check_project_structure(self) -> dict:
        """Check project structure and required files."""
        required_files = [
            "README.md",
            "setup.py",
            "metrics/",
            "bin/",
        ]

        missing_files = []
        for file_path in required_files:
            if not Path(project_root / file_path).exists():
                missing_files.append(file_path)

        result = {
            "missing_files": missing_files,
            "all_present": len(missing_files) == 0,
            "status": "âœ… Complete"
            if len(missing_files) == 0
            else f"âš ï¸  {len(missing_files)} missing",
        }

        if missing_files:
            self.issues.append(f"Missing project files: {', '.join(missing_files)}")
            self.suggestions.append("Ensure you're running from the feedback-loop project root")

        return result

    def run_environment_checks(self) -> bool:
        """Run all environment checks and display results."""
        console.print("\nğŸ” Running environment checks...", style="info")

        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            BarColumn(complete_style="green"),
            TimeElapsedColumn(),
            console=console,
        ) as progress:
            # OS Detection
            task_os = progress.add_task("Detecting OS...", total=1)
            os_info = self.detect_os()
            progress.update(task_os, completed=1)

            # Python Version
            task_python = progress.add_task("Checking Python version...", total=1)
            python_info = self.check_python_version()
            progress.update(task_python, completed=1)

            # Virtual Environment
            task_venv = progress.add_task("Checking virtual environment...", total=1)
            venv_info = self.check_virtual_environment()
            progress.update(task_venv, completed=1)

            # Dependencies
            task_deps = progress.add_task("Checking dependencies...", total=1)
            deps_info = self.check_dependencies()
            progress.update(task_deps, completed=1)

            # Project Structure
            task_project = progress.add_task("Checking project structure...", total=1)
            project_info = self.check_project_structure()
            progress.update(task_project, completed=1)

        # Display results
        table = Table(title="Environment Check Results", show_header=True, header_style="bold blue")
        table.add_column("Component", style="cyan")
        table.add_column("Status", style="green")
        table.add_column("Details", style="yellow")

        table.add_row("Operating System", os_info["display_name"], "Detected automatically")
        table.add_row("Python Version", python_info["status"], python_info["message"])
        table.add_row("Virtual Environment", venv_info["status"], venv_info["message"])
        table.add_row(
            "Dependencies",
            deps_info["status"],
            f"{len(deps_info['missing'])} missing" if deps_info["missing"] else "All present",
        )
        table.add_row(
            "Project Structure",
            project_info["status"],
            f"{len(project_info['missing_files'])} missing"
            if project_info["missing_files"]
            else "Complete",
        )

        console.print(table)

        # Check if we can proceed
        critical_issues = [
            issue for issue in self.issues if "Python version" in issue or "project files" in issue
        ]

        if critical_issues:
            console.print("\nâŒ Critical issues found that prevent setup:", style="error")
            for issue in critical_issues:
                console.print(f"  â€¢ {issue}", style="error")

            console.print("\nğŸ’¡ Suggestions:", style="warning")
            for suggestion in self.suggestions:
                console.print(f"  â€¢ {suggestion}", style="warning")

            return False

        if self.issues:
            console.print("\nâš ï¸  Non-critical issues detected:", style="warning")
            for issue in self.issues:
                if issue not in critical_issues:
                    console.print(f"  â€¢ {issue}", style="warning")

        return True

    def install_package(self) -> bool:
        """Install feedback-loop package."""
        console.print("\nğŸ“¦ Installing feedback-loop package...", style="info")

        try:
            with Progress(
                SpinnerColumn(),
                TextColumn("[progress.description]{task.description}"),
                BarColumn(complete_style="green"),
                TimeElapsedColumn(),
                console=console,
            ) as progress:
                task_install = progress.add_task("Installing package...", total=1)

                # Run pip install
                result = subprocess.run(
                    [sys.executable, "-m", "pip", "install", "-e", "."],
                    cwd=project_root,
                    capture_output=True,
                    text=True,
                    check=True,
                )

                progress.update(task_install, completed=1)

            console.print("âœ… Package installed successfully!", style="success")
            return True

        except subprocess.CalledProcessError as e:
            console.print(f"âŒ Installation failed: {e}", style="error")
            console.print(f"Error output: {e.stderr}", style="error")
            return False

    def setup_project(self) -> bool:
        """Setup project configuration."""
        console.print("\nâš™ï¸  Setting up project configuration...", style="info")

        try:
            with Progress(
                SpinnerColumn(),
                TextColumn("[progress.description]{task.description}"),
                BarColumn(complete_style="green"),
                TimeElapsedColumn(),
                console=console,
            ) as progress:
                # Create tests directory if needed
                task_tests = progress.add_task("Setting up test directory...", total=1)
                tests_dir = project_root / "tests"
                if not tests_dir.exists():
                    tests_dir.mkdir()
                    console.print("  âœ“ Created tests/ directory", style="success")
                progress.update(task_tests, completed=1)

                # Setup pytest.ini if needed
                task_pytest = progress.add_task("Configuring pytest...", total=1)
                pytest_ini = project_root / "pytest.ini"
                if not pytest_ini.exists():
                    with open(pytest_ini, "w") as f:
                        f.write("[pytest]\n")
                        f.write("addopts = --enable-metrics -v\n")
                        f.write("testpaths = tests\n")
                    console.print("  âœ“ Created pytest.ini with metrics enabled", style="success")
                progress.update(task_pytest, completed=1)

                # Copy conftest.py if needed
                task_conftest = progress.add_task("Setting up pytest plugin...", total=1)
                conftest_src = project_root / "conftest.py"
                conftest_dst = project_root / "conftest.py"
                if conftest_src.exists() and not conftest_dst.exists():
                    # Note: This is copying to itself, might be a bug in original logic
                    # We'll skip this step for now as it doesn't make sense
                    pass
                progress.update(task_conftest, completed=1)

            console.print("âœ… Project setup complete!", style="success")
            return True

        except Exception as e:
            console.print(f"âŒ Project setup failed: {e}", style="error")
            return False

    def show_next_steps(self):
        """Show next steps after successful setup."""
        console.print("\n" + "=" * 70, style="header")
        console.print("ğŸ‰ Setup Complete!", style="success", justify="center")
        console.print("=" * 70, style="header")

        console.print("\nğŸš€ Next steps:", style="info")

        steps_table = Table(show_header=False, box=None)
        steps_table.add_column("Step", style="cyan", no_wrap=True)
        steps_table.add_column("Command", style="green")
        steps_table.add_column("Description", style="yellow")

        steps_table.add_row("1", "fl-demo", "Try the interactive demo")
        steps_table.add_row("2", "pytest --enable-metrics", "Run tests with metrics collection")
        steps_table.add_row("3", "fl-explore", "Explore available patterns")
        steps_table.add_row("4", "fl-chat", "Chat with the AI assistant")
        steps_table.add_row("5", "fl-dashboard", "View analytics dashboard")

        console.print(steps_table)

        console.print("\nğŸ“š For more help:", style="info")
        console.print("  â€¢ Quick start guide: documentation/QUICKSTART.md", style="accent")
        console.print("  â€¢ Full documentation: documentation/INDEX.md", style="accent")
        console.print("  â€¢ Chat assistant: fl-chat (then type /help)", style="accent")

        console.print("\nğŸ’¡ Pro tip: Set up an API key for AI features!", style="warning")
        console.print("  â€¢ ANTHROPIC_API_KEY for Claude (recommended)", style="accent")
        console.print("  â€¢ OPENAI_API_KEY for GPT-4", style="accent")
        console.print("  â€¢ GEMINI_API_KEY for Gemini", style="accent")

    def run(self) -> int:
        """Run the bootstrap wizard."""
        self.print_header()

        # Run environment checks
        if not self.run_environment_checks():
            console.print("\nâŒ Setup cannot continue due to critical issues.", style="error")
            console.print("Please resolve the issues above and try again.", style="error")
            return 1

        # Install package if not all dependencies are present
        deps_info = self.check_dependencies()
        if not deps_info["all_installed"]:
            if Confirm.ask("\nğŸ“¦ Install missing dependencies?", default=True):
                if not self.install_package():
                    return 1
            else:
                console.print("âš ï¸  Skipping package installation.", style="warning")

        # Setup project
        if Confirm.ask("\nâš™ï¸  Set up project configuration?", default=True):
            if not self.setup_project():
                return 1

        # Show next steps
        self.show_next_steps()

        console.print("\nâœ¨ Happy coding with feedback-loop! ğŸš€\n", style="success")

        return 0


def main():
    """Main entry point."""
    wizard = BootstrapWizard()
    return wizard.run()


if __name__ == "__main__":
    sys.exit(main())
